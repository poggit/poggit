$(function(){function g(b,a){ajax("release.statechange",{data:{relId:releaseDetails.releaseId,state:b,message:a,citations:n.join(",")},method:"POST",success:function(){return location.reload()},error:function(b){var a="Unknown error has occurred, please try again later.\nError Code: "+b.status;b.responseJSON&&b.responseJSON.message&&(a=b.responseJSON.message);alert(a);location.reload()}})}var a=$("<div></div>"),h=$("<textarea cols='80' rows='3'>Dear @"+releaseDetails.project.repo.owner+",</textarea>").appendTo(a),
k=$("<textarea cols='80' rows='5'></textarea>").appendTo(a),l=$("<textarea cols='80' rows='2'></textarea>").appendTo(a),d=$("<select></select>").append($("<option value='keep' selected>Unchanged</option>")).append($("<option value='rejected'>Rejected</option>")).append($("<option value='draft'>Draft</option>"));a.append($("<div>Change state to: </div>").append(d));var p,q=$("<select></select>").appendTo(a);$("<button>Add</button>").click(function(){var b=k.val(),a=p[q.val()];b+="\n\n"+a.id+" &mdash; "+
a.title+":\n> "+a.content;n.push(a.id);k.val(b)}).appendTo(a);ajax("submit.rules.api",{success:function(b){p=b;for(var a in b)if(b.hasOwnProperty(a)){var c=b[a];q.append($("<option></option>").attr("value",c.id).text(c.id+" ("+c.uses+") - "+c.title))}}});var n=[];a.dialog({autoOpen:!1,position:modalPosition,width:.8*window.innerWidth,modal:!0,buttons:{Post:function(){var a=h.val()+"\n\n"+k.val()+"\n\n"+l.val()+"\n\n> This comment is posted here because this is the last commit when the released build was created.";
ghApi(releaseDetails.rejectPath,{body:a},"POST",function(){switch(d.val()){case "rejected":g(PoggitConsts.ReleaseState.rejected,a);break;case "draft":g(PoggitConsts.ReleaseState.draft,a)}})}}});d.change(function(){var a=d.val();"rejected"===a?(h.val("Dear @"+releaseDetails.project.repo.owner+',\n> I regret to inform you that your plugin "**'+releaseDetails.name+'**" (v'+releaseDetails.version+" submitted on "+(new Date(1E3*releaseDetails.created)).toISOString()+") has been rejected."),l.val("Please resolve these issues and submit the plugin again.")):
"draft"===a&&(h.val('There are some problems with the plugin submission form for "**'+releaseDetails.name+'**" (v'+releaseDetails.version+" submitted on "+(new Date(1E3*releaseDetails.created)).toISOString()+"):"),l.val("Your release has been reset to draft. Please [edit the release](https://poggit.pmmp.io/edit/"+releaseDetails.project.repo.owner+"/"+releaseDetails.project.repo.name+"/"+releaseDetails.project.name+"/"+releaseDetails.build.internal+') to resolve these problems, then click "Submit" on the edit page to have the plugin reviewed again.'))});
var m=$("<select class='inline-select'></select>").change(function(){return g(m.val())}),e;for(e in PoggitConsts.ReleaseState)if(PoggitConsts.ReleaseState.hasOwnProperty(e)){var r=PoggitConsts.ReleaseState[e],t=$("<option></option>").attr("value",r).text(e.ucfirst());t.prop("selected",releaseDetails.state===r);t.appendTo(m)}var f=$("<select></select>"),c;for(c in PoggitConsts.Staff)PoggitConsts.Staff.hasOwnProperty(c)&&PoggitConsts.Staff[c]>=PoggitConsts.AdminLevel.REVIEWER&&f.append($("<option></option>").attr("value",
c).text(c));f.val(sessionData.session.loginName.toLowerCase());var u=$("<div></div>").append(f).dialog({autoOpen:!1,position:modalPosition,modal:!0,title:"Assign release",buttons:{Assign:function(){return ajax("review.assign",{data:{releaseId:releaseDetails.releaseId,assignee:f.val()},success:function(){return window.location.reload()}})},Unassign:function(){return ajax("review.assign",{data:{releaseId:releaseDetails.releaseId,assignee:""},success:function(){return window.location.reload()}})}}});
$("<div id='release-admin'></div>").append($("<span class='action'>Message</span>").click(function(){a.dialog("option","title","Message author");a.dialog("open")})).append(m).append($("<span class='action'>Assign</span>").click(function(){return u.dialog("open")})).insertAfter("#release-admin-marker")});
